import os
from path import Path 

root = str(Path(os.path.abspath(os.path.dirname(__file__))).parent)

import pandas as pd 



def _get_jdict(root=root):
    japan_translate = pd.read_csv(root+'/data/japanese_prefectures.csv')
    jdict = japan_translate[['Prefecture','PrefJ']]
    return jdict 


def _add_prefecture(complete_data, jdict): 
    # Format date column
    complete_data['異動年月日'] = complete_data['異動年月日'].str.replace('-','')
    complete_data['異動年月日'] = pd.to_datetime(complete_data['異動年月日'])
    
    complete_data['year'] = pd.DatetimeIndex(complete_data['異動年月日']).year
    
    complete_data = complete_data.rename(columns={'都道府県':'PrefJ','氏名または名称':'node'})
    
    # Get the number of cows by prefecture 
    gd1 = complete_data.groupby('Individual Identification  Number', as_index=False)['PrefJ'].first()
    gd1['Individual Identification  Number'] = gd1['Individual Identification  Number'].astype(str)

    # Get the number of nodes (locations) by prefecture    
    gd2 = complete_data.groupby('node', as_index=False)['PrefJ'].first()
    gd2 = gd2.groupby('PrefJ').count().reset_index()
    
    summary = gd1.groupby('PrefJ').count()
    summary = summary.merge(gd2, on='PrefJ', how='inner')
    summary = summary.reset_index().merge(jdict, on='PrefJ', how='outer', indicator=True)
    summary = summary.rename(columns={'Individual Identification  Number':'#Cows','_merge':'merged'})
    summary['Cow_P'] = summary['#Cows']/summary['#Cows'].sum()
    summary = summary[summary['#Cows'].notnull()]
    summary['node_P'] = summary['node']/summary['node'].sum()
    
    return summary

def summary_by_prefecture(complete_data): 
    
    jdict = _get_jdict()
    summary = _add_prefecture(complete_data, jdict)
    return summary         
    
    
    
    
    
    
    
    
    
    
    